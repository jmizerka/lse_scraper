services:
  api:
    build:
      context: .
      dockerfile: app/api/Dockerfile
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - ./app/core:${APP_ROOT}/core:ro
      - ./app/api:${APP_ROOT}/api
      - ./app/utils:${APP_ROOT}/utils:ro
      - ./logs:${LOG_DIR}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${API_PORT:-8000}/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    command: >
      uvicorn api.entrypoint:app --host 0.0.0.0 --port ${API_PORT:-8000} --reload

  cli:
    build:
      context: .
      dockerfile: app/cli/Dockerfile
    volumes:
      - ./app/core:${APP_ROOT}/core:ro
      - ./app/cli:${APP_ROOT}/cli
      - ./app/utils:${APP_ROOT}/utils:ro
      - ./data/cli:${DATA_DIR}/cli
      - ./logs:${LOG_DIR}
    command: >
      python -m cli.entrypoint
      --input ${CLI_INPUT}
      --output ${CLI_OUTPUT}
    restart: "no"

  cron:
    build:
      context: .
      dockerfile: app/cron/Dockerfile
    volumes:
      - ./app/core:${APP_ROOT}/core:ro
      - ./app/cron:${APP_ROOT}/cron
      - ./app/utils:${APP_ROOT}/utils:ro
      - ./data/cron:${DATA_DIR}/cron
      - ./logs:${LOG_DIR}
    command: >
      python -m cron.entrypoint
      --input ${CRON_INPUT}
      --output ${CRON_OUTPUT}
      --cron "${CRON_SCHEDULE}"
    restart: always

  watchdog:
    build:
      context: .
      dockerfile: app/watchdog/Dockerfile
    volumes:
      - ./app/core:${APP_ROOT}/core:ro
      - ./app/watchdog:${APP_ROOT}/watchdog
      - ./app/utils:${APP_ROOT}/utils:ro
      - ./data/watchdog:${DATA_DIR}/watchdog
      - ./logs:${LOG_DIR}
    command: >
      python -m watchdog.entrypoint
      --input-dir ${WATCHDOG_INPUT_DIR}
      --output-dir ${WATCHDOG_OUTPUT_DIR}
    restart: always

